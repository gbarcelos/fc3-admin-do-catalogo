package com.fullcycle.admin.catalogo.infrastructure.api;

import static org.hamcrest.Matchers.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fullcycle.admin.catalogo.ControllerTest;
import com.fullcycle.admin.catalogo.Fixture;
import com.fullcycle.admin.catalogo.application.castmember.create.CreateCastMemberOutput;
import com.fullcycle.admin.catalogo.application.castmember.create.CreateCastMemberUseCase;
import com.fullcycle.admin.catalogo.application.castmember.delete.DeleteCastMemberUseCase;
import com.fullcycle.admin.catalogo.application.castmember.retrieve.get.GetCastMemberByIdUseCase;
import com.fullcycle.admin.catalogo.application.castmember.retrieve.list.ListCastMembersUseCase;
import com.fullcycle.admin.catalogo.application.castmember.update.UpdateCastMemberUseCase;
import com.fullcycle.admin.catalogo.domain.castmember.CastMemberID;
import java.util.Objects;

import com.fullcycle.admin.catalogo.domain.exceptions.NotificationException;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;

@ControllerTest(controllers = CastMemberAPI.class)
public class CastMemberAPITest {

  @Autowired private MockMvc mvc;

  @Autowired private ObjectMapper mapper;

  @MockBean private CreateCastMemberUseCase createCastMemberUseCase;

  @MockBean private DeleteCastMemberUseCase deleteCastMemberUseCase;

  @MockBean private GetCastMemberByIdUseCase getCastMemberByIdUseCase;

  @MockBean private ListCastMembersUseCase listCastMembersUseCase;

  @MockBean private UpdateCastMemberUseCase updateCastMemberUseCase;

  @Test
  public void givenAValidCommand_whenCallsCreateCastMember_shouldReturnItsIdentifier()
      throws Exception {
    // given
    final var expectedName = Fixture.name();
    final var expectedType = Fixture.CastMember.type();
    final var expectedId = CastMemberID.from("o1i2u3i1o");

    final var aCommand = new CreateCastMemberRequest(expectedName, expectedType);

    when(createCastMemberUseCase.execute(any()))
        .thenReturn(CreateCastMemberOutput.from(expectedId));

    // when
    final var aRequest =
        post("/cast_members")
            .contentType(MediaType.APPLICATION_JSON)
            .content(mapper.writeValueAsString(aCommand));

    final var response = this.mvc.perform(aRequest).andDo(print());

    // then
    response
        .andExpect(status().isCreated())
        .andExpect(header().string("Location", "/cast_members/" + expectedId.getValue()))
        .andExpect(header().string("Content-Type", MediaType.APPLICATION_JSON_VALUE))
        .andExpect(jsonPath("$.id", equalTo(expectedId.getValue())));

    verify(createCastMemberUseCase)
        .execute(
            argThat(
                actualCmd ->
                    Objects.equals(expectedName, actualCmd.name())
                        && Objects.equals(expectedType, actualCmd.type())));
  }

  @Test
  public void givenAnInvalidName_whenCallsCreateCastMember_shouldReturnNotification()
      throws Exception {
    // given
    final String expectedName = null;
    final var expectedType = Fixture.CastMember.type();

    final var expectedErrorMessage = "'name' should not be null";

    final var aCommand = new CreateCastMemberRequest(expectedName, expectedType);

    when(createCastMemberUseCase.execute(any()))
        .thenThrow(NotificationException.with(new Error(expectedErrorMessage)));

    // when
    final var aRequest =
        post("/cast_members")
            .contentType(MediaType.APPLICATION_JSON)
            .content(mapper.writeValueAsString(aCommand));

    final var response = this.mvc.perform(aRequest).andDo(print());

    // then
    response
        .andExpect(status().isUnprocessableEntity())
        .andExpect(header().string("Location", nullValue()))
        .andExpect(header().string("Content-Type", MediaType.APPLICATION_JSON_VALUE))
        .andExpect(jsonPath("$.errors", hasSize(1)))
        .andExpect(jsonPath("$.errors[0].message", equalTo(expectedErrorMessage)));

    verify(createCastMemberUseCase)
        .execute(
            argThat(
                actualCmd ->
                    Objects.equals(expectedName, actualCmd.name())
                        && Objects.equals(expectedType, actualCmd.type())));
  }
}
